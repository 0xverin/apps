"use strict";(("undefined"!=typeof self?self:this).webpackChunk_polkadot_apps=("undefined"!=typeof self?self:this).webpackChunk_polkadot_apps||[]).push([[8511],{18835:(e,n,t)=>{t.d(n,{B:()=>d});var s=t(37362),o=t(3066),r=function(e,n,t,s){return new(t||(t=Promise))((function(o,r){function c(e){try{i(s.next(e))}catch(e){r(e)}}function a(e){try{i(s.throw(e))}catch(e){r(e)}}function i(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,a)}i((s=s.apply(e,n||[])).next())}))},c=function(e,n,t,s){return new(t||(t=Promise))((function(o,r){function c(e){try{i(s.next(e))}catch(e){r(e)}}function a(e){try{i(s.throw(e))}catch(e){r(e)}}function i(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,a)}i((s=s.apply(e,n||[])).next())}))};function a(e){return c(this,void 0,void 0,(function*(){const{port1:n,port2:t}=new MessageChannel,s=e.portToServer,o={wasmModule:yield e.wasmModule,serverToClient:t,maxLogLevel:e.maxLogLevel,cpuRateLimit:e.cpuRateLimit,forbidWs:e.forbidWs,forbidWss:e.forbidWss,forbidNonLocalWs:e.forbidNonLocalWs,forbidTcp:e.forbidTcp,forbidWebRtc:e.forbidWebRtc};s.postMessage(o,[t]);const r={jsonRpcResponses:new Map,connections:new Map};return n.onmessage=t=>{const o=t.data;switch(o.ty){case"wasm-panic":case"executor-shutdown":n.close(),s.close();break;case"add-chain-result":if(o.success){r.jsonRpcResponses.set(o.chainId,new Array);const e={ty:"accept-more-json-rpc-answers",chainId:o.chainId};for(let t=0;t<10;++t)n.postMessage(e)}break;case"new-connection":r.connections.set(o.connectionId,new Set);break;case"connection-reset":if(!r.connections.has(o.connectionId))return;r.connections.delete(o.connectionId);break;case"connection-stream-open":if(!r.connections.has(o.connectionId))return;break;case"connection-stream-reset":if(!r.connections.has(o.connectionId))return;if(!r.connections.get(o.connectionId).has(o.streamId))return;break;case"stream-send":case"stream-send-close":if(!r.connections.has(o.connectionId))return;if(o.streamId&&!r.connections.get(o.connectionId).has(o.streamId))return;break;case"json-rpc-response":{const n=r.jsonRpcResponses.get(o.chainId);return n&&n.push(o.response),void e.eventCallback({ty:"json-rpc-responses-non-empty",chainId:o.chainId})}}e.eventCallback(o)},{addChain(e,t,s,o,r,a){return c(this,void 0,void 0,(function*(){const c={ty:"add-chain",chainSpec:e,databaseContent:t,potentialRelayChains:s,disableJsonRpc:o,jsonRpcMaxPendingRequests:r,jsonRpcMaxSubscriptions:a};n.postMessage(c)}))},removeChain(e){r.jsonRpcResponses.delete(e);const t={ty:"remove-chain",chainId:e};n.postMessage(t)},request(e,t){const s={ty:"request",chainId:t,request:e};return n.postMessage(s),0},peekJsonRpcResponse(e){const t=r.jsonRpcResponses.get(e).shift();if(!t)return null;const s={ty:"accept-more-json-rpc-answers",chainId:e};return n.postMessage(s),t},shutdownExecutor(){n.postMessage({ty:"shutdown"})},connectionReset(e,t){r.connections.delete(e);const s={ty:"connection-reset",connectionId:e,message:t};n.postMessage(s)},connectionOpened(e,t){const s={ty:"connection-opened",connectionId:e,info:t};n.postMessage(s)},streamMessage(e,t,s){const o={ty:"stream-message",connectionId:e,message:t,streamId:s};n.postMessage(o)},streamOpened(e,t,s,o){r.connections.get(e).add(t);const c={ty:"stream-opened",connectionId:e,streamId:t,direction:s,initialWritableBytes:o};n.postMessage(c)},streamWritableBytes(e,t,s){const o={ty:"stream-writable-bytes",connectionId:e,numExtra:t,streamId:s};n.postMessage(o)},streamReset(e,t){r.connections.get(e).delete(t);const s={ty:"stream-reset",connectionId:e,streamId:t};n.postMessage(s)}}}))}var i=function(e,n,t,s){return new(t||(t=Promise))((function(o,r){function c(e){try{i(s.next(e))}catch(e){r(e)}}function a(e){try{i(s.throw(e))}catch(e){r(e)}}function i(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,a)}i((s=s.apply(e,n||[])).next())}))};function d(e,n,t){const c=e.logCallback||((e,n,t)=>{e<=1?console.error("[%s] %s",n,t):2==e?console.warn("[%s] %s",n,t):3==e?console.info("[%s] %s",n,t):4==e?console.debug("[%s] %s",n,t):console.trace("[%s] %s",n,t)});n instanceof Promise||(n=Promise.resolve(n));let d=e.cpuRateLimit||1;isNaN(d)&&(d=1),d>1&&(d=1),d<0&&(d=0);const u={instance:{status:"not-created"},chainIds:new WeakMap,connections:new Map,addChainResults:[],onExecutorShutdownOrWasmPanic:()=>{},chains:new Map},f=e=>{switch(e.ty){case"wasm-panic":{console.error("Smoldot has panicked"+(e.currentTask?" while executing task `"+e.currentTask+"`":"")+". This is a bug in smoldot. Please open an issue at https://github.com/smol-dot/smoldot/issues with the following message:\n"+e.message),u.instance={status:"destroyed",error:new s.LX(e.message)},u.connections.forEach((e=>e.reset())),u.connections.clear();for(const e of u.addChainResults)e({success:!1,error:"Smoldot has crashed"});u.addChainResults=[];for(const e of Array.from(u.chains.values())){for(const n of e.jsonRpcResponsesPromises)n();e.jsonRpcResponsesPromises=[]}u.chains.clear();const n=u.onExecutorShutdownOrWasmPanic;u.onExecutorShutdownOrWasmPanic=()=>{},n();break}case"executor-shutdown":{const e=u.onExecutorShutdownOrWasmPanic;u.onExecutorShutdownOrWasmPanic=()=>{},e();break}case"log":c(e.level,e.target,e.message);break;case"add-chain-result":u.addChainResults.shift()(e);break;case"json-rpc-responses-non-empty":{const n=u.chains.get(e.chainId).jsonRpcResponsesPromises;for(;0!==n.length;)n.shift()();break}case"new-connection":{const n=e.connectionId;u.connections.set(n,t.connect({address:e.address,onConnectionReset(e){if("ready"!==u.instance.status)throw new Error;u.connections.delete(n),u.instance.instance.connectionReset(n,e)},onMessage(e,t){if("ready"!==u.instance.status)throw new Error;u.instance.instance.streamMessage(n,e,t)},onStreamOpened(e,t,s){if("ready"!==u.instance.status)throw new Error;u.instance.instance.streamOpened(n,e,t,s)},onOpen(e){if("ready"!==u.instance.status)throw new Error;u.instance.instance.connectionOpened(n,e)},onWritableBytes(e,t){if("ready"!==u.instance.status)throw new Error;u.instance.instance.streamWritableBytes(n,e,t)},onStreamReset(e){if("ready"!==u.instance.status)throw new Error;u.instance.instance.streamReset(n,e)}}));break}case"connection-reset":u.connections.get(e.connectionId).reset(),u.connections.delete(e.connectionId);break;case"connection-stream-open":u.connections.get(e.connectionId).openOutSubstream();break;case"connection-stream-reset":u.connections.get(e.connectionId).reset(e.streamId);break;case"stream-send":u.connections.get(e.connectionId).send(e.data,e.streamId);break;case"stream-send-close":u.connections.get(e.connectionId).closeSend(e.streamId)}},p=e.portToWorker;return u.instance=p?{status:"not-ready",whenReady:a({wasmModule:n.then((e=>e.wasm)),forbidTcp:e.forbidTcp||!1,forbidWs:e.forbidWs||!1,forbidNonLocalWs:e.forbidNonLocalWs||!1,forbidWss:e.forbidWss||!1,forbidWebRtc:e.forbidWebRtc||!1,maxLogLevel:e.maxLogLevel||3,cpuRateLimit:d,portToServer:p,eventCallback:f}).then((e=>{"destroyed"!==u.instance.status&&(u.instance={status:"ready",instance:e})}))}:{status:"not-ready",whenReady:n.then((n=>function(e,n,t){return r(this,void 0,void 0,(function*(){const s={instance:null,currentTask:null,bufferIndices:new Array,advanceExecutionPromise:null,stdoutBuffer:"",stderrBuffer:"",onShutdownExecutorOrWasmPanic:()=>{}},c={panic:(e,n)=>{const r=s.instance;s.instance=null,e>>>=0,n>>>=0;const c=o.yV(new Uint8Array(r.exports.memory.buffer),e,n);throw t({ty:"wasm-panic",message:c,currentTask:s.currentTask}),s.onShutdownExecutorOrWasmPanic(),s.onShutdownExecutorOrWasmPanic=()=>{},new Error},buffer_size:e=>s.bufferIndices[e].byteLength,buffer_copy:(e,n)=>{const t=s.instance;n>>>=0;const o=s.bufferIndices[e];new Uint8Array(t.exports.memory.buffer).set(o,n)},advance_execution_ready:()=>{s.advanceExecutionPromise&&s.advanceExecutionPromise(),s.advanceExecutionPromise=null},json_rpc_responses_non_empty:e=>{t({ty:"json-rpc-responses-non-empty",chainId:e})},log:(e,n,r,c,a)=>{const i=s.instance;n>>>=0,r>>>=0,c>>>=0,a>>>=0;const d=new Uint8Array(i.exports.memory.buffer);let u=o.yV(d,n,r),f=o.yV(d,c,a);t({ty:"log",level:e,message:f,target:u})},start_timer:e=>{const n=s.instance;e>2147483647&&(e=2147483647),e<1&&"function"==typeof setImmediate?setImmediate((()=>{if(s.instance)try{n.exports.timer_finished()}catch(e){}})):setTimeout((()=>{if(s.instance)try{n.exports.timer_finished()}catch(e){}}),e)},connection_type_supported:n=>{switch(n){case 0:case 1:case 2:return e.forbidTcp?0:1;case 4:case 5:case 6:return e.forbidNonLocalWs?0:1;case 7:return e.forbidWs?0:1;case 14:return e.forbidWss?0:1;case 16:case 17:return e.forbidWebRtc?0:1;default:throw new Error("Invalid connection type passed to `connection_type_supported`")}},connection_new:(e,n,r)=>{const c=s.instance,a=new Uint8Array(c.exports.memory.buffer);let i;switch(n>>>=0,r>>>=0,o.Q$(a,n)){case 0:case 1:case 2:i={ty:"tcp",port:o.n8(a,n+1),hostname:o.yV(a,n+3,r-3)};break;case 4:case 6:{const e=o.n8(a,n+1);i={ty:"websocket",url:"ws://"+o.yV(a,n+3,r-3)+":"+e};break}case 5:{const e=o.n8(a,n+1);i={ty:"websocket",url:"ws://["+o.yV(a,n+3,r-3)+"]:"+e};break}case 14:{const e=o.n8(a,n+1);i={ty:"websocket",url:"wss://"+o.yV(a,n+3,r-3)+":"+e};break}case 16:{const e=o.n8(a,n+1);i={ty:"webrtc",ipVersion:"4",remoteTlsCertificateSha256:a.slice(n+3,n+35),targetIp:o.yV(a,n+35,r-35),targetPort:e};break}case 17:{const e=o.n8(a,n+1);i={ty:"webrtc",ipVersion:"6",remoteTlsCertificateSha256:a.slice(n+3,n+35),targetIp:o.yV(a,n+35,r-35),targetPort:e};break}default:throw new Error("Invalid encoded address passed to `connection_new`")}t({ty:"new-connection",connectionId:e,address:i})},reset_connection:e=>{t({ty:"connection-reset",connectionId:e})},connection_stream_open:e=>{t({ty:"connection-stream-open",connectionId:e})},connection_stream_reset:(e,n)=>{t({ty:"connection-stream-reset",connectionId:e,streamId:n})},stream_send:(e,n,o,r)=>{const c=s.instance;o>>>=0,r>>>=0;const a=new Uint8Array(c.exports.memory.buffer).slice(o,o+r);t({ty:"stream-send",connectionId:e,streamId:n,data:a})},stream_send_close:(e,n)=>{t({ty:"stream-send-close",connectionId:e,streamId:n})},current_task_entered:(e,n)=>{e>>>=0,n>>>=0;const t=o.yV(new Uint8Array(s.instance.exports.memory.buffer),e,n);s.currentTask=t},current_task_exit:()=>{s.currentTask=null}},a={random_get:(n,t)=>{const o=s.instance;n>>>=0,t>>>=0;const r=new Uint8Array(o.exports.memory.buffer).subarray(n,n+t);for(let n=0;n<t;n+=65536)e.getRandomValues(r.subarray(n,n+65536));return 0},clock_time_get:(n,t,r)=>{const c=s.instance,a=new Uint8Array(c.exports.memory.buffer);switch(r>>>=0,n){case 0:{const e=BigInt(Math.floor(Date.now()))*BigInt(1e6);return o.VV(a,r,e),0}case 1:{const n=e.performanceNow(),t=Math.floor(n),s=BigInt(t)*BigInt(1e6)+BigInt(Math.floor(1e6*(n-t)));return o.VV(a,r,s),0}default:return 28}},fd_write:(e,n,t,r)=>{const c=s.instance;if(r>>>=0,1!=e&&2!=e)return 8;const a=new Uint8Array(c.exports.memory.buffer);let i="",d=0;for(let e=0;e<t;e++){const t=o.nm(a,n+4*e*2),s=o.nm(a,n+4*(2*e+1));i+=o.yV(a,t,s),d+=s}const u=e=>{for(;;){const n=e.indexOf("\n");if(-1==n)return e;console.log(e.substring(0,n)),e=e.substring(n+1)}};return 1==e?(s.stdoutBuffer+=i,s.stdoutBuffer=u(s.stdoutBuffer)):2==e&&(s.stderrBuffer+=i,s.stderrBuffer=u(s.stderrBuffer)),o.v7(a,r,d),0},sched_yield:()=>0,proc_exit:e=>{throw s.instance=null,t({ty:"wasm-panic",message:`proc_exit called: ${e}`,currentTask:s.currentTask}),s.onShutdownExecutorOrWasmPanic(),s.onShutdownExecutorOrWasmPanic=()=>{},new Error},environ_sizes_get:(n,t)=>{const r=s.instance;n>>>=0,t>>>=0;let c=0;e.envVars.forEach((e=>c+=(new TextEncoder).encode(e).length+1));const a=new Uint8Array(r.exports.memory.buffer);return o.v7(a,n,e.envVars.length),o.v7(a,t,c),0},environ_get:(n,t)=>{const r=s.instance;n>>>=0,t>>>=0;const c=new Uint8Array(r.exports.memory.buffer);let a=0,i=0;return e.envVars.forEach((e=>{const s=(new TextEncoder).encode(e);o.v7(c,n+a,t+i),a+=4,c.set(s,t+i),i+=s.length,o.Cg(c,t+i,0),i+=1})),0}},i=yield WebAssembly.instantiate(n,{smoldot:c,wasi_snapshot_preview1:a});s.instance=i,s.instance.exports.init(e.maxLogLevel);const d=new Promise((e=>s.onShutdownExecutorOrWasmPanic=()=>e("stop")));return(()=>{r(this,void 0,void 0,(function*(){const n=e.cpuRateLimit;let o=0,r=e.performanceNow();for(;;){const t=new Promise((e=>s.advanceExecutionPromise=()=>e("ready")));if(!s.instance)break;s.instance.exports.advance_execution();const c=e.performanceNow(),a=c-r;if(r=c,o+=a*(1/n-1),o>5){o>2147483646&&(o=2147483646);const e=new Promise((e=>setTimeout((()=>e("timeout")),o)));if("stop"===(yield Promise.race([e,d])))break}if("stop"===(yield Promise.race([t,d])))break;const i=e.performanceNow();o-=i-r,o<-1e4&&(o=-1e4),r=i}s.instance&&t({ty:"executor-shutdown"})}))})(),{request:(e,n)=>s.instance?(s.bufferIndices[0]=(new TextEncoder).encode(e),s.instance.exports.json_rpc_send(0,n)>>>0):1,peekJsonRpcResponse:e=>{if(!s.instance)return null;const n=new Uint8Array(s.instance.exports.memory.buffer),t=s.instance.exports.json_rpc_responses_peek(e)>>>0,r=o.nm(n,t)>>>0,c=o.nm(n,t+4)>>>0;if(0!==c){const t=o.yV(n,r,c);return s.instance.exports.json_rpc_responses_pop(e),t}return null},addChain:(e,n,r,c,a,i)=>{if(!s.instance)return void t({ty:"add-chain-result",success:!1,error:"Smoldot has crashed"});console.assert(c||0!=a,"invalid jsonRpcMaxPendingRequests value passed to local-instance::addChain"),s.bufferIndices[0]=(new TextEncoder).encode(e),s.bufferIndices[1]=(new TextEncoder).encode(n);const d=new Uint8Array(4*r.length);for(let e=0;e<r.length;++e)o.v7(d,4*e,r[e]);s.bufferIndices[2]=d;const u=s.instance.exports.add_chain(0,1,c?0:a,i,2);if(delete s.bufferIndices[0],delete s.bufferIndices[1],delete s.bufferIndices[2],0!=s.instance.exports.chain_is_ok(u))t({ty:"add-chain-result",success:!0,chainId:u});else{const e=s.instance.exports.chain_error_len(u)>>>0,n=s.instance.exports.chain_error_ptr(u)>>>0,r=o.yV(new Uint8Array(s.instance.exports.memory.buffer),n,e);s.instance.exports.remove_chain(u),t({ty:"add-chain-result",success:!1,error:r})}},removeChain:e=>{s.instance&&s.instance.exports.remove_chain(e)},shutdownExecutor:()=>{if(!s.instance)return;const e=s.onShutdownExecutorOrWasmPanic;s.onShutdownExecutorOrWasmPanic=()=>{},e()},connectionOpened:(e,n)=>{if(s.instance)switch(n.type){case"single-stream":s.instance.exports.connection_open_single_stream(e,n.initialWritableBytes);break;case"multi-stream":{const t=new Uint8Array(1+n.localTlsCertificateSha256.length+n.remoteTlsCertificateSha256.length);o.Cg(t,0,0),t.set(n.localTlsCertificateSha256,1),t.set(n.remoteTlsCertificateSha256,1+n.localTlsCertificateSha256.length),s.bufferIndices[0]=t,s.instance.exports.connection_open_multi_stream(e,0),delete s.bufferIndices[0];break}}},connectionReset:(e,n)=>{s.instance&&(s.bufferIndices[0]=(new TextEncoder).encode(n),s.instance.exports.connection_reset(e,0),delete s.bufferIndices[0])},streamWritableBytes:(e,n,t)=>{s.instance&&s.instance.exports.stream_writable_bytes(e,t||0,n)},streamMessage:(e,n,t)=>{s.instance&&(s.bufferIndices[0]=n,s.instance.exports.stream_message(e,t||0,0),delete s.bufferIndices[0])},streamOpened:(e,n,t,o)=>{s.instance&&s.instance.exports.connection_stream_opened(e,n,"outbound"===t?1:0,o)},streamReset:(e,n)=>{s.instance&&s.instance.exports.stream_reset(e,n)}}}))}({forbidTcp:e.forbidTcp||!1,forbidWs:e.forbidWs||!1,forbidNonLocalWs:e.forbidNonLocalWs||!1,forbidWss:e.forbidWss||!1,forbidWebRtc:e.forbidWebRtc||!1,maxLogLevel:e.maxLogLevel||3,cpuRateLimit:d,envVars:[],performanceNow:t.performanceNow,getRandomValues:t.getRandomValues},n.wasm,f))).then((e=>{"destroyed"!==u.instance.status&&(u.instance={status:"ready",instance:e})}))},{addChain:e=>i(this,void 0,void 0,(function*(){if("not-ready"===u.instance.status&&(yield u.instance.whenReady),"destroyed"===u.instance.status)throw u.instance.error;if("not-created"===u.instance.status||"not-ready"===u.instance.status)throw new Error;if("string"!=typeof e.chainSpec)throw new Error("Chain specification must be a string");let n=[];if(e.potentialRelayChains)for(const t of e.potentialRelayChains){const e=u.chainIds.get(t);void 0!==e&&n.push(e)}let t=void 0===e.jsonRpcMaxPendingRequests?1/0:e.jsonRpcMaxPendingRequests;if(t=Math.floor(t),t<=0||isNaN(t))throw new s.iA("Invalid value for `jsonRpcMaxPendingRequests`");t>4294967295&&(t=4294967295);let o=void 0===e.jsonRpcMaxSubscriptions?1/0:e.jsonRpcMaxSubscriptions;if(o=Math.floor(o),o<0||isNaN(o))throw new s.iA("Invalid value for `jsonRpcMaxSubscriptions`");if(o>4294967295&&(o=4294967295),void 0!==e.databaseContent&&"string"!=typeof e.databaseContent)throw new s.iA("`databaseContent` is not a string");const r=new Promise((e=>u.addChainResults.push(e)));u.instance.instance.addChain(e.chainSpec,e.databaseContent||"",n,!!e.disableJsonRpc,t,o);const c=yield r;if(!c.success)throw new s.iA(c.error);const a=c.chainId;u.chains.set(a,{jsonRpcResponsesPromises:new Array});const d={sendJsonRpc:n=>{if("destroyed"===u.instance.status)throw u.instance.error;if("ready"!==u.instance.status)throw new Error;if(!u.chains.has(a))throw new s.A_;if(e.disableJsonRpc)throw new s.BU;const t=u.instance.instance.request(n,a);switch(t){case 0:break;case 1:throw new s.t_;default:throw new Error("Internal error: unknown json_rpc_send error code: "+t)}},nextJsonRpcResponse:()=>i(this,void 0,void 0,(function*(){for(;;){if(!u.chains.has(a))throw new s.A_;if(e.disableJsonRpc)return Promise.reject(new s.BU);if("destroyed"===u.instance.status)throw u.instance.error;if("ready"!==u.instance.status)throw new Error;const n=u.instance.instance.peekJsonRpcResponse(a);if(n)return n;yield new Promise((e=>{u.chains.get(a).jsonRpcResponsesPromises.push(e)}))}})),remove:()=>{if("destroyed"===u.instance.status)throw u.instance.error;if("ready"!==u.instance.status)throw new Error;if(!u.chains.has(a))throw new s.A_;console.assert(u.chainIds.has(d)),u.chainIds.delete(d);for(const e of u.chains.get(a).jsonRpcResponsesPromises)e();u.chains.delete(a),u.instance.instance.removeChain(a)}};return u.chainIds.set(d,a),d})),terminate:()=>i(this,void 0,void 0,(function*(){if("not-ready"===u.instance.status&&(yield u.instance.whenReady),"destroyed"===u.instance.status)throw u.instance.error;if("ready"!==u.instance.status)throw new Error;u.instance.instance.shutdownExecutor(),u.instance={status:"destroyed",error:new s.A_},u.connections.forEach((e=>e.reset())),u.connections.clear();for(const e of u.addChainResults)e({success:!1,error:"Smoldot has crashed"});u.addChainResults=[];for(const e of Array.from(u.chains.values())){for(const n of e.jsonRpcResponsesPromises)n();e.jsonRpcResponsesPromises=[]}u.chains.clear(),yield new Promise((e=>u.onExecutorShutdownOrWasmPanic=e))}))}}}}]);